@model Lustrious.Models.Carrinho
@{
 ViewData["Title"] = "Carrinho";
}
<h2>Carrinho</h2>
@if (Model == null || Model.Items == null || !Model.Items.Any())
{
 <p>Carrinho vazio.</p>
}
else
{
 <table class="table">
 <thead>
 <tr>
 <th>Imagem</th>
 <th>Produto</th>
 <th>Código de Barras</th>
 <th>Quantidade</th>
 <th>Valor Unit.</th>
 <th>Subtotal</th>
 <th></th>
 </tr>
 </thead>
 <tbody>
 @foreach (var item in Model.Items)
 {
 <tr>
 <td>
 @if (!string.IsNullOrEmpty(item.Imagem))
 {
 <img src="@item.Imagem" alt="@item.Nome" style="max-width:80px; max-height:80px" />
 }
 </td>
 <td>@item.Nome</td>
 <td>@item.CodigoBarras</td>
 <td>
 <div class="input-group" style="max-width:150px">
 <form asp-action="DecrementarItem" method="post">
 @Html.AntiForgeryToken()
 <input type="hidden" name="produtoId" value="@item.ProdutoId" />
 <button type="submit" class="btn btn-sm btn-outline-secondary">-</button>
 </form>
 <span class="mx-2 align-middle">@item.Qtd</span>
 <form asp-action="IncrementarItem" method="post">
 @Html.AntiForgeryToken()
 <input type="hidden" name="produtoId" value="@item.ProdutoId" />
 <button type="submit" class="btn btn-sm btn-outline-secondary">+</button>
 </form>
 </div>
 </td>
 <td>@item.ValorItem.ToString("C")</td>
 <td>@(item.ValorItem * item.Qtd).ToString("C")</td>
 <td>
 <form asp-action="RemoverItem" method="post">
 @Html.AntiForgeryToken()
 <input type="hidden" name="produtoId" value="@item.ProdutoId" />
 <button type="submit" class="btn btn-sm btn-danger">Remover</button>
 </form>
 </td>
 </tr>
 }
 </tbody>
 </table>

 <div>
 <strong>Total de itens:</strong> @Model.Qtd
 </div>
 <div>
 <strong>Valor total:</strong> @Model.ValorTotal.ToString("C")
 </div>

 <form asp-action="RemoverTodosItens" method="post" style="display:inline">
 @Html.AntiForgeryToken()
 <button type="submit" class="btn btn-danger">Limpar Carrinho</button>
 </form>

 @* Simple checkout form: select address (if present) and send via AJAX to CheckoutAjax *@
 <form asp-action="CheckoutAjax" id="checkout-form" class="ajax-checkout-form" method="post">
 @Html.AntiForgeryToken()
 <div style="margin-top:12px">
 <label for="idEnd">Endereço (id):</label>
 <input type="number" id="idEnd" name="idEnd" value="0" />
 <button type="submit" class="btn btn-success">Finalizar Compra</button>
 </div>
 </form>
}
<p><a href="/">Voltar</a></p>
@section Scripts {
 <script>
 if (!checkoutForm) return;
 checkoutForm.addEventListener('submit', function(e){
 e.preventDefault();
 var token = document.querySelector('#checkout-form input[name="__RequestVerificationToken"]').value;
 var idEnd = document.getElementById('idEnd').value ||0;
 var fd = new FormData();
 fd.append('__RequestVerificationToken', token);
 fd.append('idEnd', idEnd);
 fetch('/Carrinho/CheckoutAjax', { method: 'POST', body: fd, credentials: 'same-origin' })
 .then(r => r.json()).then(function(data){
 if (!data) return;
 if (data.success){
 // update badge to zero
 var badge = document.getElementById('cart-badge'); if (badge) badge.textContent =0;
 alert(data.message || 'Compra finalizada');
 window.location = '/Venda/Index';
 } else {
 alert(data.message || 'Erro ao finalizar compra');
 }
 }).catch(()=> alert('Erro de comunicação'));
 });
 })();
 </script>
}