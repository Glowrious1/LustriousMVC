@model IEnumerable<Lustrious.Models.Produto>
@{
    ViewData["Title"] = "Produtos";
    ViewData["HideFooter"] = true;
    int currentPage = ViewBag.CurrentPage ?? 1;
    int totalPages = ViewBag.TotalPages ?? 1;
    string filterQ = ViewBag.FilterQ as string ?? string.Empty;
    int filterCategoria = ViewBag.FilterCategoria ?? 0;
    int filterTipo = ViewBag.FilterTipo ?? 0;
    var categorias = ViewBag.Categorias as IEnumerable<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem> ?? Enumerable.Empty<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>();
    var tipos = ViewBag.Tipos as IEnumerable<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem> ?? Enumerable.Empty<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>();

    var role = Context.Session.GetString("UserRole") ?? string.Empty;
    bool isStaff = role.ToLower() == "admin" || role.ToLower() == "funcionario";
}


<div id="produtos-container" class="container">

    <div class="top-row">
        <h2>Produtos</h2>
        @if (isStaff)
        {
            <a asp-action="CriarProduto" asp-controller="Produto" class="criar">Novo Produto</a>
        }
    </div>

    <form method="get" asp-action="Index" class="filters">
        <input type="text" name="q" value="@filterQ" placeholder="Pesquisar nome ou descrição..." />

        <select name="codCategoria" id="categoriaFilter">
            <option value="0">Todas Categorias</option>
            @foreach (var c in categorias)
            {
                var isSelected = (filterCategoria.ToString() == c.Value) || (c.Selected);
                if (isSelected)
                {
                    <option value="@c.Value" selected>@c.Text</option>
                }
                else
                {
                    <option value="@c.Value">@c.Text</option>
                }
            }
        </select>

        <select name="codTipoProduto" id="tipoFilter">
            <option value="0">Todos os Tipos</option>
            @foreach (var t in tipos)
            {
                var isSel = (filterTipo.ToString() == t.Value) || (t.Selected);
                if (isSel)
                {
                    <option value="@t.Value" selected>@t.Text</option>
                }
                else
                {
                    <option value="@t.Value">@t.Text</option>
                }
            }
        </select>

        <button type="submit" class="btn">Filtrar</button>
    </form>

    <table>
        <thead>
            <tr>
                <th>Foto</th>
                <th>Código</th>
                <th>Nome</th>
                <th>Qtd</th>
                <th>Valor</th>
                <th>Categoria</th>
                <th>Tipo</th>
                <th>Ações</th>
            </tr>
        </thead>

        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>
                        <img src="@(string.IsNullOrEmpty(item.Foto) ? Url.Content("~/imagens/capa_foto.png") : Url.Content("~/" + item.Foto.TrimStart('/')))" class="foto-thumb" />
                    </td>

                    <td>@item.CodigoBarras</td>
                    <td>@item.NomeProd</td>
                    <td>@item.Qtd</td>
                    <td>@item.ValorUnitario.ToString("C")</td>
                    <td>@item.NomeCategoria</td>
                    <td>@item.NomeTipoProduto</td>

                    <td>
                        @if (isStaff)
                        {
                            <a asp-action="EditarProduto" asp-route-id="@item.CodigoBarras" class="btn btn-edit">Editar</a>

                            <form asp-action="ExcluirProduto" method="post" style="display:inline; margin-left:6px">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@item.CodigoBarras" />
                                <button type="submit" class="btn btn-delete" onclick="return confirm('Confirma exclusão?');">
                                    Excluir
                                </button>
                            </form>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div class="pagination">
        @if (totalPages > 1)
        {
            if (currentPage > 1)
            {
                <a class="page-btn" asp-action="Index" asp-route-page="@(currentPage - 1)"
                   asp-route-q="@filterQ" asp-route-codCategoria="@filterCategoria" asp-route-codTipoProduto="@filterTipo">
                    « Anterior
                </a>
            }

            @for (int i = 1; i <= totalPages; i++)
            {
                if (i == currentPage)
                {
                    <span class="page-current">@i</span>
                }
                else
                {
                    <a class="page-btn" asp-action="Index" asp-route-page="@i"
                       asp-route-q="@filterQ" asp-route-codCategoria="@filterCategoria" asp-route-codTipoProduto="@filterTipo">@i</a>
                }
            }

            if (currentPage < totalPages)
            {
                <a class="page-btn" asp-action="Index" asp-route-page="@(currentPage + 1)"
                   asp-route-q="@filterQ" asp-route-codCategoria="@filterCategoria" asp-route-codTipoProduto="@filterTipo">
                    Próximo »
                </a>
            }
        }
    </div>

</div>

<script>

    (function(){
        var cat = document.getElementById('categoriaFilter');
        var tipo = document.getElementById('tipoFilter');

        if(!cat) return;

        cat.addEventListener('change', function(){

            fetch('/Produto/GetTiposPorCategoria?codCategoria=' + cat.value)
            .then(r => r.json())
            .then(data => {
                tipo.innerHTML = '<option value="0">Todos os Tipos</option>';

                data.forEach(function(i){
                    var opt = document.createElement('option');
                    opt.value = i.value;
                    opt.text = i.text;
                    tipo.appendChild(opt);
                });
            })
            .catch(()=>{});

        });

    })();

</script>

<style>

    /* COR DE FUNDO DA PÁGINA */
    body {
        background-color: #c8b68a; /* bege do fundo */
        margin: 0;
        font-family: Arial, sans-serif;
    }

    /* CONTAINER GERAL */
    #produtos-container {
        background-color: #cfc7b4; /* bege mais claro da caixa */
        width: 85%;
        max-width: 1100px;
        margin: 40px auto;
        padding: 30px;
        border: 6px solid #95845c; /* borda escura */
        border-radius: 20px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        /* avoid touching footer */
        margin-bottom: 80px;
        padding-bottom: 40px;
    }

    /* TÍTULO + BOTÃO NOVO PRODUTO */
    .top-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }

        .top-row h2 {
            font-size: 26px;
            color: #4b4b4b;
        }

        .top-row .criar {
            background-color: #6b5530;
            color: #fff;
            padding: 10px 18px;
            border-radius: 6px;
            text-decoration: none;
            transition: 0.2s;
        }

            .top-row .criar:hover {
                background-color: #8a6d3f;
            }

    /* FILTROS */
    .filters {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }

        .filters input,
        .filters select {
            padding: 10px;
            border: 2px solid #95845c;
            border-radius: 6px;
            background: #f5f5f5;
        }

        .filters .btn {
            padding: 10px 16px;
            border: none;
            background-color: #3c6b2a; /* verde igual ao botão da imagem */
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }

            .filters .btn:hover {
                background-color: #4da73b;
            }

    /* TABELA */
    table {
        width: 100%;
        border-collapse: collapse;
        background: #e8e2d4;
        border-radius: 10px;
        overflow: hidden;
    }

    thead {
        background-color: #b5a78a;
    }

        thead th {
            padding: 12px;
            color: #fff;
            font-weight: bold;
        }

    tbody tr:nth-child(even) {
        background-color: #f2eee4;
    }

    tbody td {
        padding: 10px;
        text-align: center;
        color: #4b4b4b;
    }

    /* MINIATURA FOTO */
    .foto-thumb {
        width: 55px;
        height: 55px;
        object-fit: cover;
        border-radius: 5px;
    }

    /* BOTÕES AÇÕES */
    .btn-edit {
        background-color: #6b5530;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        text-decoration: none;
        transition: 0.2s;
    }

        .btn-edit:hover {
            background-color: #8a6d3f;
        }

    .btn-delete {
        background-color: #9c2e2e;
        color: white;
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: 0.2s;
    }

        .btn-delete:hover {
            background-color: #c44141;
        }

    /* PAGINAÇÃO */
    .pagination {
        margin-top: 25px;
        text-align: center;
    }

    .page-btn,
    .page-current {
        display: inline-block;
        padding: 8px 12px;
        margin: 0 4px;
        border-radius: 6px;
    }

    .page-btn {
        background-color: #6b5530;
        color: white;
        text-decoration: none;
        transition: 0.2s;
    }

        .page-btn:hover {
            background-color: #8a6d3f;
            color: black;
        }

    .page-current {
        background-color: #3c6b2a; /* verde escuro */
        color: white;
    }


</style>